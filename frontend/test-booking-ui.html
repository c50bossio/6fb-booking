<!DOCTYPE html>
<html>
<head>
    <title>Booking Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>6FB Booking Flow Test</h1>
    <div id="output"></div>

    <script>
        const API_BASE = 'http://localhost:3000/api/proxy/api/v1/booking/public';
        const output = document.getElementById('output');

        function log(message, isError = false) {
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = message;
            output.appendChild(div);
        }

        async function testBookingFlow() {
            try {
                // 1. Get shops
                log('1. Getting shops...');
                const shopsRes = await fetch(`${API_BASE}/shops`);
                const shops = await shopsRes.json();
                log(`   Found ${shops.length} shops`);
                const shop = shops[0];
                log(`   Using: ${shop.name} (ID: ${shop.id})`);

                // 2. Get services
                log('\n2. Getting services...');
                const servicesRes = await fetch(`${API_BASE}/shops/${shop.id}/services`);
                const services = await servicesRes.json();
                log(`   Found ${services.length} services`);
                const service = services[0];
                log(`   Using: ${service.name} - $${service.base_price}`);

                // 3. Get barbers
                log('\n3. Getting barbers...');
                const barbersRes = await fetch(`${API_BASE}/shops/${shop.id}/barbers`);
                const barbers = await barbersRes.json();
                log(`   Found ${barbers.length} barbers`);
                const barber = barbers[0];
                log(`   Using: ${barber.first_name} ${barber.last_name}`);

                // 4. Get availability
                log('\n4. Getting availability...');
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 3); // Monday
                const dateStr = tomorrow.toISOString().split('T')[0];

                const availRes = await fetch(
                    `${API_BASE}/barbers/${barber.id}/availability?service_id=${service.id}&start_date=${dateStr}&end_date=${dateStr}`
                );
                const availability = await availRes.json();
                const availableSlot = availability.slots.find(s => s.available);
                log(`   Found ${availability.slots.filter(s => s.available).length} available slots`);
                log(`   Using: ${availableSlot.date} at ${availableSlot.start_time}`);

                // 5. Create booking
                log('\n5. Creating booking...');
                const bookingData = {
                    location_id: shop.id,
                    barber_id: barber.id,
                    service_id: service.id,
                    appointment_date: availableSlot.date,
                    appointment_time: availableSlot.start_time,
                    client_first_name: 'Test',
                    client_last_name: 'Customer',
                    client_email: 'test' + Date.now() + '@example.com',
                    client_phone: '5551234567',
                    notes: 'Test booking from browser',
                    timezone: shop.timezone || 'America/New_York'
                };

                const bookingRes = await fetch(`${API_BASE}/bookings/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });

                if (bookingRes.ok) {
                    const result = await bookingRes.json();
                    log('\n‚úÖ BOOKING CREATED SUCCESSFULLY!');
                    log(`   Booking token: ${result.booking_token}`);
                    log(`   Appointment ID: ${result.appointment_id}`);

                    // Show booking details
                    log('\nüìã Booking Details:');
                    log(`   Barber: ${result.appointment_details.barber}`);
                    log(`   Service: ${result.appointment_details.service}`);
                    log(`   Date: ${result.appointment_details.date}`);
                    log(`   Time: ${result.appointment_details.time}`);
                    log(`   Price: ${result.appointment_details.price}`);
                    log(`   Location: ${result.appointment_details.location}`);

                    // Create confirmation link
                    const confirmLink = document.createElement('a');
                    confirmLink.href = `/book/confirmation/${result.booking_token}`;
                    confirmLink.textContent = 'View Confirmation Page';
                    confirmLink.style.display = 'block';
                    confirmLink.style.marginTop = '20px';
                    output.appendChild(confirmLink);
                } else {
                    const error = await bookingRes.json();
                    log(`‚ùå Failed to create booking: ${error.message || error.error}`, true);
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, true);
            }
        }

        // Add test button
        const button = document.createElement('button');
        button.textContent = 'Run Booking Test';
        button.onclick = testBookingFlow;
        document.body.insertBefore(button, output);

        // Auto-run on load
        testBookingFlow();
    </script>
</body>
</html>
