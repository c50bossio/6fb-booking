<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Authentication Fix</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 40px;
            background: #f3f4f6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 { color: #111827; margin-bottom: 24px; text-align: center; }
        .step {
            margin: 20px 0;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }
        .success { border-color: #10b981; background: #f0fdf4; }
        .error { border-color: #ef4444; background: #fef2f2; }
        .warning { border-color: #f59e0b; background: #fffbeb; }
        .info { border-color: #3b82f6; background: #eff6ff; }
        button {
            background: #14b8a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 4px;
        }
        button:hover { background: #0f766e; }
        .test-btn { background: #6b7280; }
        .test-btn:hover { background: #4b5563; }
        .go-btn { background: #059669; }
        .go-btn:hover { background: #047857; }
        pre {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Dashboard Authentication Fix</h1>

        <div class="step info">
            <h3>Current Status</h3>
            <div id="current-status">Checking authentication...</div>
        </div>

        <div class="step">
            <h3>API Endpoint Tests</h3>
            <button onclick="testAllEndpoints()">Test All Endpoints</button>
            <button class="test-btn" onclick="testCalendarData()">Test Calendar Data</button>
            <div id="api-results"></div>
        </div>

        <div class="step">
            <h3>Dashboard Access</h3>
            <button class="go-btn" onclick="goToDashboard()">Go to Dashboard</button>
            <button class="test-btn" onclick="openInNewTab()">Open Dashboard in New Tab</button>
            <div id="dashboard-results"></div>
        </div>

        <div class="step">
            <h3>Calendar Direct Access</h3>
            <p>If the dashboard doesn't work, try accessing the calendar components directly:</p>
            <button onclick="testCalendarComponent()">Test Calendar Component</button>
            <button class="test-btn" onclick="createMockCalendar()">Create Mock Calendar</button>
            <div id="calendar-results"></div>
        </div>
    </div>

    <script>
        function log(elementId, message, className = '') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `step ${className}`;
            div.innerHTML = message;
            element.appendChild(div);
        }

        async function checkCurrentStatus() {
            const token = localStorage.getItem('access_token');
            const user = localStorage.getItem('user');

            if (!token) {
                document.getElementById('current-status').innerHTML = `
                    <div class="step error">
                        ‚ùå No authentication token found.
                        <a href="/auth-working.html">Go back to login</a>
                    </div>
                `;
                return false;
            }

            const userData = user ? JSON.parse(user) : null;

            document.getElementById('current-status').innerHTML = `
                <div class="step success">
                    ‚úÖ Authenticated as: <strong>${userData?.full_name || 'Unknown User'}</strong><br>
                    üìß Email: ${userData?.email || 'Unknown'}<br>
                    üè∑Ô∏è Role: ${userData?.role || 'Unknown'}<br>
                    üÜî User ID: ${userData?.id || 'Unknown'}<br>
                    üîë Token: ${token.substring(0, 20)}...
                </div>
            `;

            return true;
        }

        async function testAllEndpoints() {
            const resultDiv = document.getElementById('api-results');
            resultDiv.innerHTML = '';

            const token = localStorage.getItem('access_token');

            // Test endpoints that the dashboard might use
            const endpoints = [
                { name: 'Health Check', url: '/api/proxy/api/v1/health', auth: false },
                { name: 'Current User', url: '/api/proxy/api/v1/auth/me', auth: true },
                { name: 'Appointments', url: '/api/proxy/api/v1/appointments', auth: true },
                { name: 'Analytics Summary', url: '/api/proxy/api/v1/analytics/summary', auth: true },
                { name: 'Dashboard Stats', url: '/api/proxy/api/v1/dashboard/stats', auth: true }
            ];

            log('api-results', '<h4>Testing API Endpoints:</h4>');

            for (const endpoint of endpoints) {
                try {
                    const headers = {
                        'Content-Type': 'application/json'
                    };

                    if (endpoint.auth && token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }

                    const response = await fetch(endpoint.url, { headers });

                    if (response.ok) {
                        const data = await response.json();
                        log('api-results', `‚úÖ ${endpoint.name}: Working (${response.status})`, 'success');

                        // Show some data for key endpoints
                        if (endpoint.name === 'Current User' && data) {
                            log('api-results', `   User: ${data.first_name} ${data.last_name} (${data.email})`);
                        } else if (endpoint.name === 'Appointments' && Array.isArray(data)) {
                            log('api-results', `   Found ${data.length} appointments`);
                        }
                    } else {
                        const errorText = await response.text();
                        log('api-results', `‚ö†Ô∏è ${endpoint.name}: ${response.status} - ${errorText.substring(0, 100)}...`, 'warning');
                    }
                } catch (error) {
                    log('api-results', `‚ùå ${endpoint.name}: ${error.message}`, 'error');
                }
            }
        }

        async function testCalendarData() {
            const resultDiv = document.getElementById('api-results');

            log('api-results', '<h4>Testing Calendar Data Sources:</h4>');

            const token = localStorage.getItem('access_token');
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };

            try {
                // Test appointments endpoint
                const apptResponse = await fetch('/api/proxy/api/v1/appointments', { headers });

                if (apptResponse.ok) {
                    const appointments = await apptResponse.json();
                    log('api-results', `‚úÖ Calendar data: ${appointments.length} appointments found`, 'success');

                    if (appointments.length > 0) {
                        log('api-results', `   Latest: ${appointments[0].service?.name || 'Unknown Service'} on ${new Date(appointments[0].appointment_datetime).toLocaleDateString()}`);
                    } else {
                        log('api-results', '   üìù No appointments - calendar will be empty', 'warning');
                        log('api-results', '   üí° This is why the calendar appears broken - no data to display');
                    }
                } else {
                    log('api-results', `‚ùå Cannot access appointment data: ${apptResponse.status}`, 'error');
                }

            } catch (error) {
                log('api-results', `‚ùå Calendar data test failed: ${error.message}`, 'error');
            }
        }

        function goToDashboard() {
            log('dashboard-results', 'üîÑ Redirecting to dashboard...', 'info');

            // Store auth state one more time
            const token = localStorage.getItem('access_token');
            const user = localStorage.getItem('user');

            if (token && user) {
                // Also set as cookies for better compatibility
                document.cookie = `access_token=${token}; path=/; max-age=86400; SameSite=Lax`;
                document.cookie = `user=${encodeURIComponent(user)}; path=/; max-age=86400; SameSite=Lax`;

                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 1000);
            } else {
                log('dashboard-results', '‚ùå Missing authentication data', 'error');
            }
        }

        function openInNewTab() {
            window.open('/dashboard', '_blank');
        }

        async function testCalendarComponent() {
            log('calendar-results', 'üîÑ Testing calendar component access...', 'info');

            try {
                // Try to access a calendar-specific endpoint
                const response = await fetch('/api/proxy/api/v1/calendar/events', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    log('calendar-results', '‚úÖ Calendar component accessible', 'success');
                } else {
                    log('calendar-results', `‚ö†Ô∏è Calendar endpoint: ${response.status}`, 'warning');
                }
            } catch (error) {
                log('calendar-results', `Calendar test: ${error.message}`, 'info');
            }

            // Provide direct calendar access
            log('calendar-results', `
                <h4>Calendar Access Options:</h4>
                <button onclick="window.open('/dashboard', '_blank')" style="background: #059669; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 4px;">
                    Dashboard (New Tab)
                </button>
                <button onclick="window.location.href='/dashboard'" style="background: #14b8a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 4px;">
                    Dashboard (Current Tab)
                </button>
            `);
        }

        async function createMockCalendar() {
            log('calendar-results', 'üîÑ Creating mock calendar with sample data...', 'info');

            // Create a simple calendar view with current auth
            const calendarHtml = `
                <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 16px;">
                    <h3>üìÖ Mock Calendar View</h3>
                    <p><strong>User:</strong> ${JSON.parse(localStorage.getItem('user') || '{}').full_name}</p>
                    <p><strong>Status:</strong> Authenticated ‚úÖ</p>
                    <div style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 16px; margin-top: 12px;">
                        <h4>Today's Schedule</h4>
                        <p style="color: #6b7280;">No appointments scheduled</p>
                        <p style="font-size: 14px; color: #9ca3af;">
                            This is why your calendar appears "broken" - there's simply no appointment data to display.
                            The authentication is working fine!
                        </p>
                    </div>
                    <button onclick="window.location.href='/dashboard'"
                            style="background: #14b8a6; color: white; border: none; padding: 10px 20px; border-radius: 6px; margin-top: 16px;">
                        Go to Real Dashboard
                    </button>
                </div>
            `;

            log('calendar-results', calendarHtml);
        }

        // Run initial checks
        window.addEventListener('load', async () => {
            await checkCurrentStatus();
            // Auto-test endpoints
            setTimeout(testAllEndpoints, 1000);
        });
    </script>
</body>
</html>
