<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Reset & Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 BookedBarber Browser Reset & Connection Test</h1>
        
        <div class="step info">
            <h3>Step 1: Clear All Browser Data</h3>
            <button onclick="clearAllData()">Clear localStorage, sessionStorage & cookies</button>
            <div id="clearStatus"></div>
        </div>

        <div class="step info">
            <h3>Step 2: Test Backend Connection</h3>
            <button onclick="testBackendConnection()">Test Backend API</button>
            <div id="connectionStatus"></div>
        </div>

        <div class="step info">
            <h3>Step 3: Test Authentication Flow</h3>
            <button onclick="testAuthFlow()">Test Auth Endpoints</button>
            <div id="authStatus"></div>
        </div>

        <div class="step info">
            <h3>Step 4: Complete Reset</h3>
            <p>After running the tests above, click this button and then go to: <a href="http://localhost:3000/login" target="_blank">http://localhost:3000/login</a></p>
            <button onclick="completeReset()">Complete Reset & Reload</button>
        </div>

        <div class="step">
            <h3>Debug Log:</h3>
            <div id="debugLog" class="log"></div>
        </div>
    </div>

    <script>
        let log = [];
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.push(`[${timestamp}] ${message}`);
            document.getElementById('debugLog').textContent = log.join('\n');
        }

        function updateStatus(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${isSuccess ? 'success' : 'error'}">${message}</div>`;
        }

        async function clearAllData() {
            try {
                // Clear localStorage
                const localStorageKeys = Object.keys(localStorage);
                localStorage.clear();
                addLog(`Cleared ${localStorageKeys.length} localStorage items: ${localStorageKeys.join(', ')}`);

                // Clear sessionStorage
                const sessionStorageKeys = Object.keys(sessionStorage);
                sessionStorage.clear();
                addLog(`Cleared ${sessionStorageKeys.length} sessionStorage items: ${sessionStorageKeys.join(', ')}`);

                // Clear all cookies for this domain
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                addLog('Cleared all cookies for localhost');

                updateStatus('clearStatus', '✅ Successfully cleared all browser data!');
            } catch (error) {
                addLog(`Error clearing data: ${error.message}`);
                updateStatus('clearStatus', `❌ Error: ${error.message}`, false);
            }
        }

        async function testBackendConnection() {
            const backendUrl = 'http://localhost:8000';
            
            try {
                // Test health endpoint
                addLog('Testing backend health endpoint...');
                const healthResponse = await fetch(`${backendUrl}/health`, {
                    method: 'GET',
                    credentials: 'omit'
                });
                
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    addLog(`Health check success: ${JSON.stringify(healthData)}`);
                    updateStatus('connectionStatus', '✅ Backend is accessible and healthy!');
                } else {
                    throw new Error(`Health check failed: ${healthResponse.status}`);
                }

                // Test CORS
                addLog('Testing CORS with a simple request...');
                const corsResponse = await fetch(`${backendUrl}/api/v2/auth/me`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                addLog(`CORS test response: ${corsResponse.status} ${corsResponse.statusText}`);
                
            } catch (error) {
                addLog(`Backend connection error: ${error.message}`);
                updateStatus('connectionStatus', `❌ Backend connection failed: ${error.message}`, false);
            }
        }

        async function testAuthFlow() {
            const backendUrl = 'http://localhost:8000';
            
            try {
                addLog('Testing authentication endpoints...');
                
                // Test auth/me endpoint (should return 401 when not authenticated)
                const meResponse = await fetch(`${backendUrl}/api/v2/auth/me`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (meResponse.status === 401) {
                    const errorData = await meResponse.json();
                    addLog(`Auth/me correctly returned 401: ${JSON.stringify(errorData)}`);
                } else {
                    addLog(`Unexpected auth/me response: ${meResponse.status}`);
                }

                // Test login endpoint structure
                const loginResponse = await fetch(`${backendUrl}/api/v2/auth/login`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'wrongpassword'
                    })
                });
                
                addLog(`Login endpoint test: ${loginResponse.status} ${loginResponse.statusText}`);
                
                updateStatus('authStatus', '✅ Authentication endpoints are responding correctly!');
                
            } catch (error) {
                addLog(`Auth flow test error: ${error.message}`);
                updateStatus('authStatus', `❌ Auth test failed: ${error.message}`, false);
            }
        }

        async function completeReset() {
            await clearAllData();
            addLog('Performing complete reset...');
            
            // Force a hard reload
            setTimeout(() => {
                window.location.href = 'http://localhost:3000/login';
            }, 1000);
        }

        // Auto-run initial log
        addLog('Browser Reset Tool loaded');
        addLog(`User Agent: ${navigator.userAgent}`);
        addLog(`Current URL: ${window.location.href}`);
    </script>
</body>
</html>