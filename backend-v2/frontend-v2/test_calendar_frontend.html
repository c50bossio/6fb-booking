<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Frontend Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-header {
            background: #2563eb;
            color: white;
            padding: 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            font-size: 18px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .test-pass {
            background-color: #dcfce7;
            border-color: #16a34a;
            color: #15803d;
        }
        .test-fail {
            background-color: #fef2f2;
            border-color: #dc2626;
            color: #dc2626;
        }
        .test-warning {
            background-color: #fefce8;
            border-color: #ca8a04;
            color: #a16207;
        }
        .iframe-container {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: #2563eb;
            color: white;
            cursor: pointer;
            font-weight: 500;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .test-log {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .summary {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .summary h3 {
            margin-top: 0;
            color: #1e293b;
        }
        .progress-bar {
            background: #e5e7eb;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üìÖ Calendar System End-to-End Test</h1>
    <p>This test validates the complete calendar functionality by testing both frontend and backend integration.</p>

    <div class="test-container">
        <div class="test-header">Test Configuration</div>
        <div>
            <p><strong>Frontend URL:</strong> <span id="frontendUrl">http://localhost:3000</span></p>
            <p><strong>Backend URL:</strong> <span id="backendUrl">http://localhost:8000</span></p>
            <p><strong>Test User:</strong> authtest@example.com</p>
        </div>
    </div>

    <div class="test-container">
        <div class="test-header">Test Controls</div>
        <div class="test-controls">
            <button onclick="runAllTests()">üöÄ Run All Tests</button>
            <button onclick="testBookingFlow()">üìã Test Booking Flow</button>
            <button onclick="testCalendarViews()">üìÖ Test Calendar Views</button>
            <button onclick="testAPIIntegration()">üîå Test API Integration</button>
            <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>
    </div>

    <div class="test-container">
        <div class="test-header">Test Results Summary</div>
        <div class="summary">
            <h3>Overall Health Score</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="healthScore" style="width: 0%">0%</div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
                <div>
                    <strong>Passed:</strong> <span id="passedCount">0</span>
                </div>
                <div>
                    <strong>Failed:</strong> <span id="failedCount">0</span>
                </div>
                <div>
                    <strong>Warnings:</strong> <span id="warningCount">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="test-container">
        <div class="test-header">Live Test Results</div>
        <div id="testResults"></div>
        <div class="test-log" id="testLog"></div>
    </div>

    <div class="test-container">
        <div class="test-header">Calendar Page Preview</div>
        <p>This iframe shows the actual calendar page for visual inspection:</p>
        <div class="iframe-container">
            <iframe id="calendarFrame" src="about:blank"></iframe>
        </div>
    </div>

    <div class="test-container">
        <div class="test-header">Booking Page Preview</div>
        <p>This iframe shows the actual booking page for visual inspection:</p>
        <div class="iframe-container">
            <iframe id="bookingFrame" src="about:blank"></iframe>
        </div>
    </div>

    <script>
        let testResults = {
            passed: 0,
            failed: 0,
            warnings: 0,
            tests: []
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const logElement = document.getElementById('testLog');
            const prefix = {
                info: 'üìù',
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            }[type] || 'üìù';
            
            logElement.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`${prefix} ${message}`);
        }

        function addTestResult(name, status, details = '') {
            const testResult = { name, status, details, timestamp: new Date().toISOString() };
            testResults.tests.push(testResult);
            
            if (status === 'PASSED') testResults.passed++;
            else if (status === 'FAILED') testResults.failed++;
            else if (status === 'WARNING') testResults.warnings++;
            
            updateTestResultsDisplay();
            updateSummary();
        }

        function updateTestResultsDisplay() {
            const resultsContainer = document.getElementById('testResults');
            resultsContainer.innerHTML = '';
            
            testResults.tests.forEach(test => {
                const div = document.createElement('div');
                div.className = `test-result test-${test.status.toLowerCase()}`;
                div.innerHTML = `
                    <strong>${test.name}</strong>: ${test.status}
                    ${test.details ? `<br><small>${test.details}</small>` : ''}
                `;
                resultsContainer.appendChild(div);
            });
        }

        function updateSummary() {
            document.getElementById('passedCount').textContent = testResults.passed;
            document.getElementById('failedCount').textContent = testResults.failed;
            document.getElementById('warningCount').textContent = testResults.warnings;
            
            const total = testResults.passed + testResults.failed;
            const healthScore = total > 0 ? Math.round((testResults.passed / total) * 100) : 0;
            
            const healthElement = document.getElementById('healthScore');
            healthElement.style.width = `${healthScore}%`;
            healthElement.textContent = `${healthScore}%`;
            
            // Color based on health score
            if (healthScore >= 80) {
                healthElement.style.background = 'linear-gradient(90deg, #10b981, #059669)';
            } else if (healthScore >= 60) {
                healthElement.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
            } else {
                healthElement.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
            }
        }

        async function makeAPIRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                let data = null;
                try {
                    data = await response.json();
                } catch (e) {
                    // Response might not be JSON
                }
                
                return {
                    ok: response.ok,
                    status: response.status,
                    data
                };
            } catch (error) {
                log(`API request failed: ${error.message}`, 'error');
                return {
                    ok: false,
                    status: 0,
                    error: error.message
                };
            }
        }

        async function testAPIIntegration() {
            log('Testing API integration...', 'info');
            
            // Test 1: Authentication
            try {
                const authResponse = await makeAPIRequest('http://localhost:8000/api/v1/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        username: 'authtest@example.com',
                        password: 'testpass123'
                    })
                });
                
                if (authResponse.ok && authResponse.data.access_token) {
                    addTestResult('API Authentication', 'PASSED', 'Successfully obtained access token');
                    
                    const token = authResponse.data.access_token;
                    
                    // Test 2: Get user profile
                    const profileResponse = await makeAPIRequest('http://localhost:8000/api/v1/auth/me', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    
                    if (profileResponse.ok) {
                        addTestResult('User Profile API', 'PASSED', `Email: ${profileResponse.data.email}`);
                    } else {
                        addTestResult('User Profile API', 'FAILED', `Status: ${profileResponse.status}`);
                    }
                    
                    // Test 3: Get appointments
                    const appointmentsResponse = await makeAPIRequest('http://localhost:8000/api/v1/appointments/', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    
                    if (appointmentsResponse.ok) {
                        const count = appointmentsResponse.data.appointments ? appointmentsResponse.data.appointments.length : 0;
                        addTestResult('Appointments API', 'PASSED', `Retrieved ${count} appointments`);
                    } else {
                        addTestResult('Appointments API', 'FAILED', `Status: ${appointmentsResponse.status}`);
                    }
                    
                    // Test 4: Get available slots
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const dateStr = tomorrow.toISOString().split('T')[0];
                    
                    const slotsResponse = await makeAPIRequest(`http://localhost:8000/api/v1/appointments/slots?appointment_date=${dateStr}`, {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    
                    if (slotsResponse.ok) {
                        const count = slotsResponse.data.slots ? slotsResponse.data.slots.length : 0;
                        addTestResult('Available Slots API', 'PASSED', `Retrieved ${count} time slots`);
                    } else {
                        addTestResult('Available Slots API', 'FAILED', `Status: ${slotsResponse.status}`);
                    }
                    
                } else {
                    addTestResult('API Authentication', 'FAILED', `Status: ${authResponse.status}`);
                }
            } catch (error) {
                addTestResult('API Integration', 'FAILED', `Error: ${error.message}`);
            }
        }

        async function testFrontendConnectivity() {
            log('Testing frontend connectivity...', 'info');
            
            try {
                const response = await fetch('http://localhost:3000');
                if (response.ok) {
                    addTestResult('Frontend Server', 'PASSED', 'Frontend server is accessible');
                    return true;
                } else {
                    addTestResult('Frontend Server', 'FAILED', `Status: ${response.status}`);
                    return false;
                }
            } catch (error) {
                addTestResult('Frontend Server', 'FAILED', `Connection error: ${error.message}`);
                return false;
            }
        }

        async function testBackendConnectivity() {
            log('Testing backend connectivity...', 'info');
            
            try {
                const response = await fetch('http://localhost:8000/docs');
                if (response.ok) {
                    addTestResult('Backend Server', 'PASSED', 'Backend server is accessible');
                    return true;
                } else {
                    addTestResult('Backend Server', 'FAILED', `Status: ${response.status}`);
                    return false;
                }
            } catch (error) {
                addTestResult('Backend Server', 'FAILED', `Connection error: ${error.message}`);
                return false;
            }
        }

        function testCalendarViews() {
            log('Testing calendar views...', 'info');
            
            const calendarFrame = document.getElementById('calendarFrame');
            calendarFrame.src = 'http://localhost:3000/calendar';
            
            calendarFrame.onload = () => {
                try {
                    // Basic load test
                    addTestResult('Calendar Page Load', 'PASSED', 'Calendar page loaded successfully');
                    
                    // Test if we can access the iframe content (same origin)
                    try {
                        const frameDoc = calendarFrame.contentDocument || calendarFrame.contentWindow.document;
                        if (frameDoc.title) {
                            addTestResult('Calendar Page Content', 'PASSED', `Page title: ${frameDoc.title}`);
                        }
                    } catch (e) {
                        addTestResult('Calendar Page Content', 'WARNING', 'Cannot access iframe content (likely due to CORS)');
                    }
                } catch (error) {
                    addTestResult('Calendar Page Load', 'FAILED', `Error: ${error.message}`);
                }
            };
            
            calendarFrame.onerror = () => {
                addTestResult('Calendar Page Load', 'FAILED', 'Failed to load calendar page');
            };
        }

        function testBookingFlow() {
            log('Testing booking flow...', 'info');
            
            const bookingFrame = document.getElementById('bookingFrame');
            bookingFrame.src = 'http://localhost:3000/book';
            
            bookingFrame.onload = () => {
                try {
                    addTestResult('Booking Page Load', 'PASSED', 'Booking page loaded successfully');
                    
                    try {
                        const frameDoc = bookingFrame.contentDocument || bookingFrame.contentWindow.document;
                        if (frameDoc.title) {
                            addTestResult('Booking Page Content', 'PASSED', `Page title: ${frameDoc.title}`);
                        }
                        
                        // Check for common booking elements
                        const serviceCards = frameDoc.querySelectorAll('.service-card, [data-testid*="service"], button');
                        if (serviceCards.length > 0) {
                            addTestResult('Booking Services', 'PASSED', `Found ${serviceCards.length} interactive elements`);
                        } else {
                            addTestResult('Booking Services', 'WARNING', 'No service selection elements found');
                        }
                    } catch (e) {
                        addTestResult('Booking Page Content', 'WARNING', 'Cannot access iframe content (CORS limitations)');
                    }
                } catch (error) {
                    addTestResult('Booking Page Load', 'FAILED', `Error: ${error.message}`);
                }
            };
            
            bookingFrame.onerror = () => {
                addTestResult('Booking Page Load', 'FAILED', 'Failed to load booking page');
            };
        }

        async function runAllTests() {
            log('üöÄ Starting comprehensive calendar system test...', 'info');
            clearResults();
            
            // Test 1: Server connectivity
            const frontendOk = await testFrontendConnectivity();
            const backendOk = await testBackendConnectivity();
            
            if (!frontendOk || !backendOk) {
                log('‚ùå Server connectivity failed - some tests will be skipped', 'error');
            }
            
            // Test 2: API Integration
            if (backendOk) {
                await testAPIIntegration();
            }
            
            // Test 3: Frontend tests
            if (frontendOk) {
                testCalendarViews();
                setTimeout(() => {
                    testBookingFlow();
                }, 2000); // Delay to avoid loading both iframes simultaneously
            }
            
            log('‚úÖ Test suite completed', 'success');
        }

        function clearResults() {
            testResults = { passed: 0, failed: 0, warnings: 0, tests: [] };
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('testLog').innerHTML = '';
            updateSummary();
        }

        // Initialize
        log('üìÖ Calendar Test Suite initialized', 'info');
        log('Click "Run All Tests" to start the comprehensive test suite', 'info');
    </script>
</body>
</html>