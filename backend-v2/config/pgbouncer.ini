# PgBouncer configuration for BookedBarber V2 Production
# Place this file at /etc/pgbouncer/pgbouncer.ini on your database server

[databases]
# Database connection string
# Format: dbname = host=hostname port=5432 dbname=actualdb user=username
bookedbarber_prod = host=localhost port=5432 dbname=bookedbarber user=bookedbarber_app

# Read replica for read-heavy queries (future implementation)
# bookedbarber_read = host=read-replica.example.com port=5432 dbname=bookedbarber user=bookedbarber_readonly

[pgbouncer]
# Connection pool mode
# transaction = pool per transaction (recommended for web apps)
pool_mode = transaction

# Authentication settings
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

# Network settings
listen_addr = *
listen_port = 6432

# Pool size configuration
# These work in conjunction with SQLAlchemy's connection pool
default_pool_size = 25        # Per-user/database pair
min_pool_size = 10           # Maintain minimum connections
reserve_pool_size = 5        # Additional connections for super users
reserve_pool_timeout = 3     # Timeout for reserve pool

# Maximum connections
max_client_conn = 1000       # Total client connections allowed
max_db_connections = 100     # Total backend connections per database

# Timeouts
server_lifetime = 3600       # 1 hour - connection lifetime
server_idle_timeout = 600    # 10 minutes - idle connection timeout
server_connect_timeout = 15  # Connection timeout to backend
server_login_retry = 15      # Retry failed connections after 15s
query_timeout = 0           # No query timeout (handled by PostgreSQL)
query_wait_timeout = 120    # 2 minutes - wait for server connection
client_idle_timeout = 0     # No idle timeout for clients
client_login_timeout = 60   # Client authentication timeout

# Logging
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid
admin_users = pgbouncer_admin
stats_users = pgbouncer_stats, pgbouncer_admin

# Security
# Disable server_reset_query for better performance
server_reset_query = 
server_check_delay = 30     # Check backend connections every 30s
server_check_query = select 1

# Performance optimizations
pkt_buf = 4096             # Larger packet buffer
max_packet_size = 16777216 # 16MB max packet size
tcp_keepalive = 1          # Enable TCP keepalive
tcp_keepidle = 600         # 10 minutes
tcp_keepintvl = 10         # 10 seconds
tcp_keepcnt = 9            # 9 probes

# Monitoring
stats_period = 60          # Update stats every minute

# --- userlist.txt format ---
# Create /etc/pgbouncer/userlist.txt with:
# "username" "md5 hashed password"
# Example:
# "bookedbarber_app" "md5abcdef1234567890abcdef1234567890"
# "pgbouncer_admin" "md5fedcba0987654321fedcba0987654321"