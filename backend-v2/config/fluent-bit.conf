# =============================================================================
# Fluent-bit Configuration for BookedBarber V2
# =============================================================================
# üìä Collects logs from all Docker containers and application files
# üè∑Ô∏è Enriches logs with metadata and parsing
# üì§ Forwards to Elasticsearch for storage and analysis
# =============================================================================

[SERVICE]
    Flush         5
    Daemon        off
    Log_Level     info
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    Health_Check  On

# =============================================================================
# Input Sources
# =============================================================================

# Docker Container Logs
[INPUT]
    Name              forward
    Listen            0.0.0.0
    Port              24224
    Buffer_Chunk_Size 1M
    Buffer_Max_Size   6M

# FastAPI Application Logs
[INPUT]
    Name              tail
    Tag               app.backend.*
    Path              /logs/backend/*.log
    Path_Key          file
    Parser            json
    Refresh_Interval  5
    Read_from_Head    true
    Skip_Long_Lines   On
    Skip_Empty_Lines  On

# Next.js Application Logs  
[INPUT]
    Name              tail
    Tag               app.frontend.*
    Path              /logs/frontend/*.log
    Path_Key          file
    Parser            json
    Refresh_Interval  5
    Read_from_Head    true
    Skip_Long_Lines   On
    Skip_Empty_Lines  On

# Nginx Access Logs
[INPUT]
    Name              tail
    Tag               nginx.access
    Path              /logs/nginx/access.log
    Path_Key          file
    Parser            nginx
    Refresh_Interval  5

# Nginx Error Logs
[INPUT]
    Name              tail
    Tag               nginx.error
    Path              /logs/nginx/error.log
    Path_Key          file
    Parser            nginx_error
    Refresh_Interval  5

# PostgreSQL Logs
[INPUT]
    Name              tail
    Tag               postgres.*
    Path              /logs/postgres/*.log
    Path_Key          file
    Parser            postgres
    Refresh_Interval  10

# =============================================================================
# Filters and Processing
# =============================================================================

# Add Docker metadata
[FILTER]
    Name                modify
    Match               *
    Add                 environment ${ENVIRONMENT}
    Add                 service_name bookedbarber
    Add                 version ${APP_VERSION}

# Parse and enrich backend logs
[FILTER]
    Name                parser
    Match               app.backend.*
    Key_Name            log
    Parser              fastapi_json
    Reserve_Data        On

# Parse and enrich frontend logs
[FILTER]
    Name                parser
    Match               app.frontend.*
    Key_Name            log
    Parser              nextjs_json
    Reserve_Data        On

# Add severity levels
[FILTER]
    Name                modify
    Match               app.*
    Condition           Key_value_matches level ERROR
    Add                 severity error

[FILTER]
    Name                modify
    Match               app.*
    Condition           Key_value_matches level WARN
    Add                 severity warning

[FILTER]
    Name                modify
    Match               app.*
    Condition           Key_value_matches level INFO
    Add                 severity info

# Kubernetes-style metadata (if running in K8s)
[FILTER]
    Name                kubernetes
    Match               kube.*
    Kube_URL            https://kubernetes.default.svc:443
    Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
    Merge_Log           On
    K8S-Logging.Parser  On
    K8S-Logging.Exclude Off

# =============================================================================
# Output Destinations
# =============================================================================

# Primary output to Elasticsearch
[OUTPUT]
    Name              es
    Match             *
    Host              elasticsearch
    Port              9200
    Index             bookedbarber-logs
    Type              _doc
    Time_Key          @timestamp
    Time_Key_Format   %Y-%m-%dT%H:%M:%S.%L%z
    Time_Key_Nanos    Off
    Include_Tag_Key   On
    Tag_Key           _tag
    Logstash_Format   On
    Logstash_Prefix   bookedbarber
    Logstash_DateFormat %Y.%m.%d
    Retry_Limit       5
    Replace_Dots      On
    Trace_Error       On
    Current_Time_Index On

# Backup output to file (for debugging)
[OUTPUT]
    Name              file
    Match             app.*
    Path              /logs/fluent-bit
    File              application.log
    Format            json_lines

# Health check output
[OUTPUT]
    Name              http
    Match             fluent-bit.health
    Host              127.0.0.1
    Port              8080
    URI               /health
    Format            json